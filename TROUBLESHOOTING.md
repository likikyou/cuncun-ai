# 常见问题与故障排除

本章节整理了在使用 My Echo 高情感 AI 伴侣框架过程中可能遇到的常见问题及其解决方案。如果您在使用过程中遇到了本章节未涵盖的问题，欢迎在 GitHub 仓库中提交 Issue，我们会尽快为您解答。

## 1. 环境与安装问题

### 1.1 启动时报错 "ModuleNotFoundError"

这是最常见的安装问题之一，通常意味着 Python 找不到项目所需的依赖模块。错误信息可能类似于 `ModuleNotFoundError: No module named 'flask'` 或 `ModuleNotFoundError: No module named 'chromadb'`。

出现这个问题的原因通常有以下几种：

第一种原因是虚拟环境未激活。请确认您已经正确创建并激活了 Python 虚拟环境。在 Linux 或 macOS 上，激活后的命令提示符前应该显示 `(.venv)` 标识；在 Windows 上同样如此。如果没有看到该标识，请执行激活命令（参考安装指南中的相应章节）。

第二种原因是依赖未正确安装。请执行 `pip list` 或 `uv pip list` 命令查看已安装的包列表，确认 `flask`、`chromadb`、`openai` 等核心依赖是否在列表中。如果缺少某些包，请重新运行 `pip install -r requirements.txt` 或 `uv pip install -r requirements.txt` 进行安装。

第三种原因是虚拟环境路径配置错误。如果您使用 Gunicorn 或 systemd 启动服务，请确保启动命令使用的是虚拟环境中的 Python 解释器，例如 `/path/to/project/.venv/bin/python` 或 `/path/to/project/.venv/bin/gunicorn`。

### 1.2 Python 版本不兼容

某些依赖库要求特定版本的 Python，如果您的 Python 版本过低，可能会遇到安装失败或运行时错误。My Echo 要求 Python 版本不低于 3.10。

检查当前 Python 版本的方法是在终端执行 `python --version` 或 `python3 --version` 命令。如果返回的版本号低于 3.10，您需要升级 Python。

在 Ubuntu 系统上升级 Python，可以添加 deadsnakes PPA 源后安装：

```bash
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.10 python3.10-venv python3.10-dev
```

在 Windows 系统上，请前往 [Python 官方网站](https://www.python.org/downloads/)下载并安装最新版本的 Python 安装包。安装时请勾选「Add Python to PATH」选项。

在 macOS 上，如果使用 Homebrew，可以执行 `brew install python` 来升级 Python。

### 1.3 uv 或 pip 安装速度慢

如果您在安装依赖时遇到网络速度慢或连接超时的问题，可以尝试更换 pip 源来加速下载。以下是几个国内常用的 pip 镜像源：

清华源使用方法如下：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

阿里源使用方法如下：

```bash
pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

如果您使用 uv，可以在 `uv pip install` 命令后加上 `--index-url` 参数指定镜像源：

```bash
uv pip install -r requirements.txt --index-url https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 1.4 Windows 下编码问题

在 Windows 系统中运行 Python 时，可能会遇到字符编码相关的问题，特别是在处理中文内容时。常见的错误信息包括 `UnicodeDecodeError: 'utf-8' codec can't decode byte...` 或日志中出现乱码。

解决方法是确保所有文件操作都使用 UTF-8 编码。在代码层面，My Echo 已经处理了这个问题；但如果您在命令行中查看日志，可能会遇到乱码。

解决命令行乱码的方法是执行以下命令，将控制台编码设置为 UTF-8：

```powershell
chcp 65001
```

另外，建议在 Windows Terminal 或新的命令提示符中使用 PowerShell 或 Windows Terminal，而不是传统的 cmd.exe，因为它们对 Unicode 的支持更好。

## 2. 飞书平台连接问题

### 2.1 回调验证失败

当您在飞书开放平台配置回调 URL 后，可能会遇到验证失败的问题。飞书服务器会向您的回调地址发送一个 GET 请求来验证令牌是否匹配，如果验证失败，会显示「验证令牌失败」或类似的错误信息。

解决这个问题需要检查以下几个方面：

首先，确认 `FEISHU_VERIFY_TOKEN` 配置正确。这个值必须与您在飞书开放平台事件订阅页面填写的验证令牌完全一致，包括大小写和特殊字符。建议复制粘贴而不是手动输入，以避免输入错误。

其次，确认服务器可以从公网访问。飞书服务器需要能够访问您的回调 URL，您可以通过在浏览器中访问该 URL 来测试。如果服务器部署在防火墙后面，请确保防火墙已开放相应端口；如果服务器有安全组规则（如云服务器），请在云平台控制台中配置入站规则。

第三，确认服务器正在运行且端口已监听。执行 `curl http://您的服务器地址:端口号/` 或在浏览器中访问该地址，应该能够看到响应（虽然可能返回错误状态码）。如果连接超时，说明服务器可能未启动或端口未正确配置。

### 2.2 消息无法接收

如果回调验证通过，但用户发送消息后服务器没有收到任何请求，可能是以下原因导致的：

第一种原因是应用未发布。在飞书开放平台中，创建应用版本后需要提交审核并发布到企业。只有发布后，普通用户才能在飞书客户端中搜索到应用并发送消息。请检查应用的「版本管理与发布」页面，确认应用版本状态为「已发布」。

第二种原因是事件订阅未正确配置。请确认您已经在事件订阅页面订阅了「接收消息」事件，并且事件状态为「已生效」。有时候修改配置后需要重新发布应用才能生效。

第三种原因是签名校验失败。如果您的 `FEISHU_ENCRYPT_KEY` 配置不正确，可能会导致签名校验失败，从而拒绝飞书的请求。请检查加密密钥配置是否正确，或者暂时禁用加密（在飞书开放平台的事件订阅页面关闭加密选项）来测试是否是加密导致的问题。

### 2.3 消息无法发送

如果服务器能够收到消息，但回复消息发送失败，可能是以下原因导致的：

第一种原因是权限不足。请确认应用已开通 `im:message` 和 `im:message:send_as_bot` 权限，并且已发布新版本。

第二种原因是 API 调用频率超限。飞书对 API 调用频率有限制，如果短时间内发送大量消息，可能会被限流。请检查是否在短时间内发送了过多消息，或者查看飞书开放平台的 API 调用统计。

第三种原因是 Token 失效。飞书的访问令牌（Tenant Access Token）有效期为 2 小时，如果服务器长时间运行后突然无法发送消息，可能是令牌刷新逻辑有问题。请查看服务器日志，确认 Token 获取和刷新是否正常。

### 2.4 如何获取 Open ID

Open ID 是飞书用户在特定应用中的唯一标识，用于向特定用户发送消息。获取 Open ID 的方法如下：

首先，启动服务器并确保飞书机器人已正常工作。然后，在飞书客户端中向机器人发送任意消息（问候语即可）。消息发送后，查看服务器的日志文件（默认位于 `logs/feishu-cuncun.log`），在日志中搜索「open_id」或「OPEN_ID」，您会看到类似以下格式的日志记录：

```
收到用户消息 user_text=你好 open_id=ou_xxxxxxxxxxxxxxxxxx
```

其中 `ou_xxxxxxxxxxxxxxxxxx` 就是该用户的 Open ID。将这个值填入 `.env` 文件中的 `ADMIN_OPEN_ID` 配置项，您就可以收到系统告警通知了。

## 3. AI 模型相关问题

### 3.1 DeepSeek API 调用失败

如果 AI 回复内容为「我有点累了」或日志中出现与 DeepSeek API 相关的错误，说明 API 调用可能失败了。

首先，检查 `DEEPSEEK_API_KEY` 是否正确配置。错误的 API Key 会导致认证失败。请登录 DeepSeek 平台，确认 API Key 仍然有效且未被删除或禁用。

其次，检查 API 配额是否充足。DeepSeek 对 API 调用有每日限额和速率限制，如果配额用尽，API 会返回配额相关的错误。请登录 DeepSeek 平台查看配额使用情况。

第三，检查网络连接。服务器需要能够访问 `https://api.deepseek.com`，请确认服务器网络没有限制对该地址的访问。您可以在服务器上执行 `curl https://api.deepseek.com` 来测试网络连通性。

第四，查看错误日志获取更多信息。服务器日志中通常会记录 API 调用的错误信息，包括错误码和错误描述。请仔细阅读日志中的错误信息，根据具体错误进行排查。

### 3.2 AI 回复质量不佳

如果您发现 AI 的回复不够理想，可以从以下几个方面进行优化：

首先是优化提示词。`prompt_template.txt` 文件中定义的角色设定对 AI 回复风格有重大影响。您可以尝试细化角色描述、添加更多行为规范或示例对话，使 AI 的行为更加符合预期。

其次是调整模型参数。在 `cuncun_utils.py` 中的 `call_ai` 函数里，可以调整 `temperature`、`max_tokens`、`presence_penalty` 等参数。`temperature` 控制回复的随机性，较低的值（0.7 以下）使回复更确定性，较高的值（0.8 以上）使回复更有创意。

第三是优化历史记忆。系统会根据对话历史生成回复，如果历史记录中包含不相关内容，可能会影响回复质量。您可以定期清理数据库中的无效对话，或调整 `get_recent_history` 函数中的历史数量限制。

### 3.3 硅基流动 API 问题

如果启用了语音匹配功能但向量检索失败，可能是硅基流动 API 配置有问题。

首先，确认 `SILICONFLOW_API_KEY` 是否正确配置。如果没有配置此密钥，向量检索功能将不可用。

其次，检查硅基流动 API 的调用是否正常。您可以直接调用硅基流动的 Embedding API 来测试：

```bash
curl -X POST "https://api.siliconflow.cn/v1/embeddings" \
  -H "Authorization: Bearer 您的API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model": "BAAI/bge-large-zh-v1.5", "input": "测试文本"}'
```

如果 API 返回错误，请根据错误信息排查原因。

## 4. 数据库相关问题

### 4.1 数据库文件不存在

启动时如果出现类似「Unable to open database file」或找不到数据库文件的错误，可能是以下原因导致的：

第一种原因是首次运行时尚未创建数据库。首次运行时，系统会自动创建 SQLite 数据库文件。如果目录权限不足，数据库文件可能无法创建。请确认项目目录（特别是 `backups` 和 `logs` 目录）具有写权限。

第二种原因是路径配置错误。请检查 `.env` 文件中的 `DB_PATH`、`MEMORY_PATH`、`ASSETS_PATH` 等路径配置是否正确。这些路径应该指向有效的目录。

第三种原因是数据库文件被误删或移动。如果数据库文件被删除或移动到其他位置，需要重新初始化。您可以删除现有的数据库文件（如果有重要数据请先备份），然后重新启动服务，系统会自动创建新的数据库。

### 4.2 数据库连接错误

如果出现数据库连接相关的错误，如 `sqlite3.OperationalError: database is locked`，通常是因为多个进程同时访问同一个数据库文件。

对于 SQLite 数据库，虽然它支持多线程读取，但写入操作是串行的。如果您在多个地方同时写入数据库，可能会出现锁定错误。建议使用单独的数据库管理器来处理所有数据库操作，避免并发写入。

如果您使用 Gunicorn 部署，建议将工作进程数设置为较小值（如 2 或 4），因为过多的工作进程会增加数据库并发访问的压力。

### 4.3 数据库备份失败

自动备份或手动备份失败可能由以下原因导致：

第一种原因是备份目录不存在或无写权限。请确认 `BACKUP_DIR` 配置指向的目录存在且具有写权限。

第二种原因是磁盘空间不足。请检查服务器磁盘空间，如果空间不足，备份操作会失败。

第三种原因是数据库正在被占用。如果备份时数据库正在被写入，可能会导致备份失败。自动备份通常安排在凌晨 2 点进行，此时用户活动较少，可以减少备份失败的风险。

## 5. 语音功能问题

### 5.1 语音匹配失败

如果机器人没有发送语音回复，或者日志显示语音匹配失败，可能是以下原因导致的：

第一种原因是语音库目录不存在或为空。请确认 `VOICE_LIB` 配置的目录存在，并且目录中包含音频文件。如果没有创建语音库，机器人将只发送文本回复。

第二种原因是 ChromaDB 向量库未初始化。语音匹配功能依赖 ChromaDB 向量库来检索最相似的音频。如果 `ASSETS_PATH` 目录不存在或为空，需要先初始化向量库。

第三种原因是匹配阈值设置过高。在 `cuncun_utils.py` 的 `match_voice_file` 函数中，有匹配阈值（默认 0.48）的设置。如果阈值过高，可能导致大多数查询都无法找到匹配项。您可以适当降低阈值来提高匹配率。

第四种原因是向量计算失败。请检查 `SILICONFLOW_API_KEY` 是否正确配置，以及向量计算是否正常。向量计算失败会导致无法进行语音匹配。

### 5.2 音频文件上传失败

如果语音文件已匹配成功，但上传到飞书失败，可能是以下原因导致的：

第一种原因是音频格式不支持。飞书支持的音频格式有限，请确认音频文件格式正确（OPUS 格式通常可以）。

第二种原因是文件路径错误。请确认 `VOICE_LIB` 路径配置正确，并且匹配到的文件路径有效。

第三种原因是权限不足。请确认应用已开通 `im:resource` 权限，用于上传音频文件到飞书。

### 5.3 如何准备语音库

要启用语音功能，您需要准备一个包含大量语音片段的语音库。以下是语音库的准备工作指南：

音频文件要求如下：格式应为 OPUS 编码的音频文件（.ogg 或 .opus 后缀），采样率建议为 16kHz 或 24kHz，每条语音长度建议在 2 到 10 秒之间。

文件命名建议如下：文件命名应包含语音内容的关键字，例如「好的呀.ogg」、「我知道了.ogg」等。这有助于在向量匹配时找到更合适的音频。

目录结构如下：将所有音频文件放入 `音频数据/CunCun_Opus_Library` 目录中。首次运行后，系统会自动在该目录下创建 ChromaDB 向量库索引。

## 6. 日志与监控问题

### 6.1 日志文件未生成

如果 `logs` 目录中没有生成日志文件，可能是以下原因导致的：

第一种原因是日志目录不存在。请手动创建 `logs` 目录，或确保 `LOG_FILE` 配置的路径存在。

第二种原因是日志级别配置问题。请确认日志配置正确，系统默认会输出 INFO 级别及以上的日志。

第三种原因是权限不足。请确认运行进程的用户对日志目录有写权限。

### 6.2 日志内容解读

My Echo 使用 JSON 格式的结构化日志，便于程序解析和分析。以下是常见日志条目的含义：

收到用户消息的日志格式如下：

```
{"timestamp": "2026-01-31T19:00:00", "level": "INFO", "name": "feishu-utils", "message": "收到用户消息", "user_text": "你好", "open_id": "ou_xxx"}
```

存存回复成功的日志格式如下：

```
{"timestamp": "2026-01-31T19:00:01", "level": "INFO", "name": "feishu-utils", "message": "存存回复成功", "reply_preview": "你好呀，有什么..."}
```

匹配命中的日志格式如下：

```
{"timestamp": "2026-01-31T19:00:01", "level": "INFO", "name": "feishu-utils", "message": "匹配命中", "sentence": "你好", "filename": "hello.ogg", "distance": 0.1234}
```

### 6.3 健康检查失败

访问 `/health` 端点返回非 healthy 状态时，可以根据返回的具体信息判断问题所在：

如果 `ai` 为 `false`，说明 DeepSeek AI 客户端初始化失败，可能是 API Key 配置错误或网络问题。

如果 `voice_db` 为 `false`，说明 ChromaDB 向量库加载失败，可能是向量库目录不存在或已损坏。

如果 `feishu_api` 为 `false`，说明飞书 API 连接失败，可能是 App ID 或 App Secret 配置错误。

## 7. 性能与资源问题

### 7.1 服务器资源占用过高

如果服务器 CPU 或内存占用过高，可以考虑以下优化措施：

减少工作进程数：如果使用 Gunicorn 部署，可以减少 `-w` 参数的值，降低进程数可以减少资源占用，但也会降低并发处理能力。

启用数据库维护：系统会自动进行数据库维护，但您也可以定期手动清理旧的对话记录以减少数据库大小。

优化日志级别：如果不需要详细日志，可以将日志级别设置为 WARNING 或 ERROR，减少 I/O 操作。

### 7.2 响应速度慢

如果用户反映机器人回复速度慢，可以从以下几个方面排查：

检查 AI API 响应时间：在日志中查找 `duration` 字段，如果该值较大（超过 5 秒），说明 DeepSeek API 响应较慢，可能是网络问题或 API 负载较高。

检查向量匹配性能：如果语音匹配功能启用，向量检索也可能需要一定时间。请确认 ChromaDB 索引文件没有过大。

检查服务器性能：如果服务器 CPU 或内存资源紧张，也会影响响应速度。请监控系统资源使用情况。

### 7.3 消息丢失或重复

如果发现消息丢失（用户发送消息但没有收到回复）或消息重复（同一消息被处理多次），可能是以下原因导致的：

消息排重机制：系统使用 `processed_ids` 队列来防止重复处理同一消息。如果该队列已满（最大 1000 条），较早的消息可能会被重新处理。

消息确认超时：飞书要求服务器在收到消息后及时返回响应。如果处理时间过长（超过 3 秒），飞书可能会重试发送消息。

网络问题：不稳定的网络连接可能导致消息丢失或重复。请确保服务器网络稳定。

## 8. 其他常见问题

### 8.1 如何修改角色名称

要修改 AI 伴侣的角色名称（如将「存存」改为其他名字），需要修改以下内容：

第一处是 `prompt_template.txt` 文件，将其中的角色名称和描述修改为新的角色信息。

第二处是 `feishu_cuncun_pro.py` 中的日志输出和提示文本，如果需要的话。

第三处是飞书应用名称（在飞书开放平台修改），这是用户在搜索机器人时看到的名称。

### 8.2 如何禁用加密验证（开发测试）

在开发测试阶段，您可能希望禁用加密验证以简化调试。要禁用加密验证，请执行以下操作：

在飞书开放平台的事件订阅页面，关闭「启用加密」选项。

在 `.env` 文件中，注释掉或删除 `FEISHU_ENCRYPT_KEY` 配置项。

重启服务，此时签名校验会自动跳过解密步骤。

重要提示：生产环境中请务必启用加密，以确保消息安全。

### 8.3 如何完全重置项目

如果您希望完全重置项目（包括所有数据和配置），可以按照以下步骤操作：

第一，停止运行中的服务。

第二，备份重要数据（如 `.env` 文件中的配置信息）。

第三，删除以下目录和文件：`logs/` 目录、`backups/` 目录、`AI_banlu_cuncun_memory.db` 文件、`cuncun_memory_db/` 目录、`音频数据/cuncun_assets_db/` 目录。

第四，保留 `.env` 文件（已配置好的环境变量）。

第五，重新启动服务，系统会自动初始化新的数据库和配置。

### 8.4 联系我们

如果您在使用过程中遇到了本章节未涵盖的问题，可以通过以下方式获取帮助：

在 GitHub 仓库中提交 Issue，详细描述您遇到的问题、错误信息以及您已经尝试过的解决方法。

查看项目的 Wiki 页面，可能有其他用户分享的经验和解决方案。

如果需要紧急技术支持，可以通过项目主页提供的联系方式联系开发者。

在提交 Issue 时，请提供以下信息以帮助我们更快地定位问题：操作系统和版本、Python 版本、项目日志（特别是错误相关的部分）、`.env` 文件的配置（注意隐藏敏感信息如 API Key）、复现问题的具体步骤。
